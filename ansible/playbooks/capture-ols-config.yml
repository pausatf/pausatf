---
- name: Capture OpenLiteSpeed marketplace configuration from target
  hosts: staging
  gather_facts: yes
  become: yes

  vars:
    capture_dir: "artifacts/capture/{{ inventory_hostname }}"

  tasks:
    - name: Create local capture directory
      local_action:
        module: file
        path: "{{ capture_dir }}"
        state: directory
        mode: '0755'

    - name: Capture OLS main config
      fetch:
        src: /usr/local/lsws/conf/httpd_config.conf
        dest: "{{ capture_dir }}/httpd_config.conf"
        flat: yes

    - name: Capture OLS vhost configs
      fetch:
        src: /usr/local/lsws/conf/vhosts
        dest: "{{ capture_dir }}/vhosts"
        flat: no

    - name: List installed lsphp packages
      command: dpkg -l | grep -E "^ii\s+lsphp|^ii\s+openlitespeed"
      register: lsphp_pkgs
      changed_when: false

    - name: Save package list
      local_action:
        module: copy
        dest: "{{ capture_dir }}/packages.txt"
        content: "{{ lsphp_pkgs.stdout }}\n"

    - name: Capture service status
      shell: |
        systemctl status lshttpd --no-pager || true
        systemctl status memcached --no-pager || true
        systemctl status redis-server --no-pager || true
        systemctl status mysql --no-pager || true
      register: svc_status
      changed_when: false

    - name: Save service status
      local_action:
        module: copy
        dest: "{{ capture_dir }}/services.txt"
        content: "{{ svc_status.stdout }}\n"

    - name: Capture Certbot renewal timers/units
      shell: |
        systemctl list-timers | grep -i certbot || true
        crontab -l || true
      register: certbot_info
      changed_when: false

    - name: Save certbot info
      local_action:
        module: copy
        dest: "{{ capture_dir }}/certbot.txt"
        content: "{{ certbot_info.stdout }}\n"

---
- name: Capture WordPress plugins/themes from production
  hosts: production
  gather_facts: no
  become: false

  vars:
    wp_bin: "{{ wpcli_path | default('/usr/local/bin/wp') }}"
    wp_path: "{{ wordpress_path | default('/var/www/html') }}"
    out_dir: "{{ playbook_dir }}/../group_vars/production"
    out_file: "{{ out_dir }}/wordpress.yml"

  tasks:
    - name: Check WP-CLI
      raw: "sg www-data -c '{{ wp_bin }} --version'"
      register: wpcli_v
      changed_when: false

    - name: List plugins (JSON)
      raw: "sg www-data -c '{{ wp_bin }} plugin list --format=json --path={{ wp_path }} 2>/dev/null | head -1'"
      register: plugins_json
      changed_when: false

    - name: List themes (JSON)
      raw: "sg www-data -c '{{ wp_bin }} theme list --format=json --path={{ wp_path }} 2>/dev/null | head -1'"
      register: themes_json
      changed_when: false

    - name: Parse plugins JSON
      set_fact:
        plugins_list: "{{ (plugins_json.stdout | trim | from_json) }}"
      delegate_to: localhost

    - name: Parse themes JSON
      set_fact:
        themes_list: "{{ (themes_json.stdout | trim | from_json) }}"
      delegate_to: localhost

    - name: Ensure local output directory exists
      delegate_to: localhost
      file:
        path: "{{ out_dir }}"
        state: directory
        mode: '0755'

    - name: Write captured vars to group_vars/production/wordpress.yml
      delegate_to: localhost
      copy:
        dest: "{{ out_file }}"
        mode: '0644'
        content: |
          # Generated by capture-wp-inventory.yml on {{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}
          # Do not edit manually; re-run the playbook to refresh from production.
          wp_main_plugins:
          {% for p in plugins_list %}
            - name: {{ p.name | to_json }}
              status: {{ p.status | to_json }}
              version: {{ p.version | to_json }}
              auto_update: {{ p.auto_update | to_json }}
          {% endfor %}

          wp_main_themes:
          {% for t in themes_list %}
            - name: {{ t.name | to_json }}
              status: {{ t.status | to_json }}
              version: {{ t.version | to_json }}
              auto_update: {{ t.auto_update | to_json }}
          {% endfor %}

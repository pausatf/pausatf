---
- name: Capture WordPress plugins/themes from production
  hosts: production
  gather_facts: no
  become: false

  vars:
    wp_bin: "{{ wpcli_path | default('/usr/local/bin/wp') }}"
    wp_path: "{{ wordpress_path | default('/var/www/html') }}"
    out_dir: "{{ playbook_dir }}/../group_vars/production"
    out_file: "{{ out_dir }}/wordpress.yml"

  tasks:
    - name: Check WP-CLI
      raw: "sg www-data -c '{{ wp_bin }} --version'"
      register: wpcli_v
      changed_when: false

    - name: List plugins (JSON)
      raw: "sg www-data -c '{{ wp_bin }} plugin list --format=json --path={{ wp_path }} 2>/dev/null | head -1'"
      register: plugins_json
      changed_when: false

    - name: List themes (JSON)
      raw: "sg www-data -c '{{ wp_bin }} theme list --format=json --path={{ wp_path }} 2>/dev/null | head -1'"
      register: themes_json
      changed_when: false

    - name: Get active template (parent theme)
      raw: "sg www-data -c '{{ wp_bin }} option get template --path={{ wp_path }} 2>/dev/null | head -1'"
      register: active_template
      changed_when: false

    - name: Get active stylesheet (child theme)
      raw: "sg www-data -c '{{ wp_bin }} option get stylesheet --path={{ wp_path }} 2>/dev/null | head -1'"
      register: active_stylesheet
      changed_when: false

    - name: Get child theme customizations
      raw: "sg www-data -c '{{ wp_bin }} option get theme_mods_{{ active_stylesheet.stdout | trim }} --format=json --path={{ wp_path }} 2>/dev/null | head -1'"
      register: child_theme_mods
      changed_when: false
      ignore_errors: true

    - name: Get parent theme customizations
      raw: "sg www-data -c '{{ wp_bin }} option get theme_mods_{{ active_template.stdout | trim }} --format=json --path={{ wp_path }} 2>/dev/null | head -1'"
      register: parent_theme_mods
      changed_when: false
      ignore_errors: true

    - name: Get WordPress users list
      raw: "sg www-data -c '{{ wp_bin }} user list --format=json --fields=ID,user_login,user_email,roles,user_registered --path={{ wp_path }} 2>/dev/null | head -1'"
      register: users_json
      changed_when: false

    - name: Get site URL
      raw: "sg www-data -c '{{ wp_bin }} option get siteurl --path={{ wp_path }} 2>/dev/null | head -1'"
      register: site_url
      changed_when: false

    - name: Get site name
      raw: "sg www-data -c '{{ wp_bin }} option get blogname --path={{ wp_path }} 2>/dev/null | head -1'"
      register: site_name
      changed_when: false

    - name: Get admin email
      raw: "sg www-data -c '{{ wp_bin }} option get admin_email --path={{ wp_path }} 2>/dev/null | head -1'"
      register: admin_email
      changed_when: false

    - name: Get permalink structure
      raw: "sg www-data -c '{{ wp_bin }} option get permalink_structure --path={{ wp_path }} 2>/dev/null | head -1'"
      register: permalink_structure
      changed_when: false

    - name: Get site language
      raw: "sg www-data -c '{{ wp_bin }} option get WPLANG --path={{ wp_path }} 2>/dev/null | head -1'"
      register: site_language
      changed_when: false

    - name: Get WordPress menus
      raw: "sg www-data -c '{{ wp_bin }} menu list --format=json --path={{ wp_path }} 2>/dev/null | head -1'"
      register: menus_json
      changed_when: false

    - name: Get rewrite rules count
      raw: "sg www-data -c '{{ wp_bin }} rewrite list --format=count --path={{ wp_path }} 2>/dev/null | head -1'"
      register: rewrite_count
      changed_when: false

    - name: Parse plugins JSON
      set_fact:
        plugins_list: "{{ (plugins_json.stdout | trim | from_json) }}"
      delegate_to: localhost

    - name: Parse themes JSON
      set_fact:
        themes_list: "{{ (themes_json.stdout | trim | from_json) }}"
      delegate_to: localhost

    - name: Parse child theme mods
      set_fact:
        child_mods: "{{ (child_theme_mods.stdout | trim | from_json) if child_theme_mods.stdout | trim else {} }}"
      delegate_to: localhost
      when: child_theme_mods is not skipped

    - name: Parse parent theme mods
      set_fact:
        parent_mods: "{{ (parent_theme_mods.stdout | trim | from_json) if parent_theme_mods.stdout | trim else {} }}"
      delegate_to: localhost
      when: parent_theme_mods is not skipped

    - name: Parse users JSON
      set_fact:
        users_list: "{{ (users_json.stdout | trim | from_json) }}"
      delegate_to: localhost

    - name: Parse menus JSON
      set_fact:
        menus_list: "{{ (menus_json.stdout | trim | from_json) if menus_json.stdout | trim else [] }}"
      delegate_to: localhost

    - name: Ensure local output directory exists
      delegate_to: localhost
      file:
        path: "{{ out_dir }}"
        state: directory
        mode: '0755'

    - name: Write captured vars to group_vars/production/wordpress.yml
      delegate_to: localhost
      copy:
        dest: "{{ out_file }}"
        mode: '0644'
        content: |
          # Generated by capture-wp-inventory.yml on {{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}
          # Do not edit manually; re-run the playbook to refresh from production.
          wp_main_plugins:
          {% for p in plugins_list %}
            - name: {{ p.name | to_json }}
              status: {{ p.status | to_json }}
              version: {{ p.version | to_json }}
              auto_update: {{ p.auto_update | to_json }}
          {% endfor %}

          wp_main_themes:
          {% for t in themes_list %}
            - name: {{ t.name | to_json }}
              status: {{ t.status | to_json }}
              version: {{ t.version | to_json }}
              auto_update: {{ t.auto_update | to_json }}
          {% endfor %}

          # Active theme configuration
          wp_active_template: {{ active_template.stdout | trim | to_json }}
          wp_active_stylesheet: {{ active_stylesheet.stdout | trim | to_json }}

          # Theme customizations (theme_mods)
          {% if child_mods is defined and child_mods %}
          wp_child_theme_mods: {{ child_mods | to_nice_yaml(indent=2) | indent(2) }}
          {% endif %}
          {% if parent_mods is defined and parent_mods %}
          wp_parent_theme_mods: {{ parent_mods | to_nice_yaml(indent=2) | indent(2) }}
          {% endif %}

          # Site configuration
          wp_site_url: {{ site_url.stdout | trim | to_json }}
          wp_site_name: {{ site_name.stdout | trim | to_json }}
          wp_admin_email: {{ admin_email.stdout | trim | to_json }}
          wp_permalink_structure: {{ permalink_structure.stdout | trim | to_json }}
          wp_site_language: {{ site_language.stdout | trim | to_json }}
          wp_rewrite_rules_count: {{ rewrite_count.stdout | trim }}

          # WordPress menus
          wp_menus:
          {% for m in menus_list %}
            - term_id: {{ m.term_id }}
              name: {{ m.name | to_json }}
              slug: {{ m.slug | to_json }}
              locations: {{ m.locations | to_json }}
              count: {{ m.count }}
          {% endfor %}

          # WordPress users and permissions
          wp_users:
          {% for u in users_list %}
            - id: {{ u.ID }}
              username: {{ u.user_login | to_json }}
              email: {{ u.user_email | to_json }}
              roles: {{ u.roles | to_json }}
              registered: {{ u.user_registered | to_json }}
          {% endfor %}

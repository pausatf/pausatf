---
- name: Capture WordPress plugins/themes from production
  hosts: production
  gather_facts: no
  become: yes

  vars:
    wp_bin: "{{ wpcli_path | default('/usr/local/bin/wp') }}"
    wp_path: "{{ wordpress_path | default('/var/www/html') }}"
    out_dir: "{{ playbook_dir }}/../group_vars/production"
    out_file: "{{ out_dir }}/wordpress.yml"

  tasks:
    - name: Check WP-CLI
      command: "{{ wp_bin }} --version"
      register: wpcli_v
      changed_when: false

    - name: List plugins (JSON)
      command: "{{ wp_bin }} plugin list --format=json --path={{ wp_path }} --allow-root"
      register: plugins_json
      changed_when: false

    - name: List themes (JSON)
      command: "{{ wp_bin }} theme list --format=json --path={{ wp_path }} --allow-root"
      register: themes_json
      changed_when: false

    - name: Ensure local output directory exists
      delegate_to: localhost
      file:
        path: "{{ out_dir }}"
        state: directory
        mode: '0755'

    - name: Write captured vars to group_vars/production/wordpress.yml
      delegate_to: localhost
      copy:
        dest: "{{ out_file }}"
        mode: '0644'
        content: |
          # Generated by capture-wp-inventory.yml on {{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}
          # Do not edit manually; re-run the playbook to refresh from production.
          wp_main_plugins:
          {% for p in (plugins_json.stdout | from_json) %}
            - name: {{ p.title | to_json }}
              slug: {{ p.name | to_json }}
              status: {{ p.status | to_json }}
              version: {{ p.version | to_json }}
          {% endfor %}

          wp_main_themes:
          {% for t in (themes_json.stdout | from_json) %}
            - name: {{ t.title | to_json }}
              slug: {{ t.name | to_json }}
              status: {{ t.status | to_json }}
              version: {{ t.version | to_json }}
          {% endfor %}

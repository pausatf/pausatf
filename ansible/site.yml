---
# PAUSATF WordPress Server Deployment Playbook
# ==============================================
# Based on audit of ftp.pausatf.org (pausatforg20230516-primary)
#
# Server Details:
#   - Ubuntu 20.04.6 LTS (Focal Fossa)
#   - 4 CPU cores, 8GB RAM
#   - DigitalOcean Droplet (sfo2)
#   - Web Server: Apache or OpenLiteSpeed (per-environment)
#   - PHP: per-environment (8.3/8.4 for new hosts)
#   - MySQL: per-environment (8.0+ for new hosts)
#   - WordPress: per-environment (latest on stage/dev)
#   - Cloudflare CDN/DNS (Free plan, SSL Full/Strict)
#
# Usage:
#   ansible-playbook -i inventory site.yml
#   ansible-playbook -i inventory site.yml --tags "webserver"
#   ansible-playbook -i inventory site.yml --tags "cloudflare"
#   ansible-playbook -i inventory site.yml --check --diff

- name: Deploy PAUSATF WordPress Server
  hosts: webservers
  become: yes
  gather_facts: yes

  vars_files:
    - group_vars/all.yml
    - group_vars/vault.yml

  pre_tasks:
    - name: Validate target is Ubuntu
      assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_major_version | int >= 20
        fail_msg: "This playbook is designed for Ubuntu 20.04+"

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Display infrastructure info
      debug:
        msg: |
          Infrastructure Details:
          =======================
          Hosting: DigitalOcean ({{ digitalocean_region }})
          Droplet: {{ digitalocean_droplet_name }} ({{ digitalocean_size }})
          CDN/DNS: Cloudflare ({{ cloudflare_zone }})
          SSL Mode: {{ cloudflare_ssl_mode }}
      tags: always

  roles:
    - role: common
      tags: [common, base]

    - role: fail2ban
      tags: [fail2ban, security]

    - role: mysql
      tags: [mysql, database]

    # Web server selection per environment
    - role: lsphp
      when: web_server | default('apache') == 'openlitespeed'
      tags: [php, web, webserver]

    - role: openlitespeed
      when: web_server | default('apache') == 'openlitespeed'
      tags: [openlitespeed, web, webserver]

    - role: php
      when: web_server | default('apache') == 'apache'
      tags: [php, web, webserver]

    - role: apache
      when: web_server | default('apache') == 'apache'
      tags: [apache, web, webserver]

    - role: cloudflare
      tags: [cloudflare, cdn, dns]
      when: cloudflare_enabled | default(false)

    - role: wordpress
      tags: [wordpress, app]

    - role: newrelic
      tags: [newrelic, monitoring]
      when: newrelic_enabled | default(false)

    - role: monitoring
      tags: [monitoring]

  post_tasks:
    - name: Verify core services are running
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop: "{{ [ 'mysql', 'fail2ban', 'cron' ] + (web_server == 'openlitespeed' | ternary(['lshttpd'], ['apache2'])) }}"
      tags: verify

    - name: Display deployment summary
      debug:
        msg: |
          Deployment Complete!
          ====================

          Infrastructure:
            - DigitalOcean: {{ digitalocean_droplet_name }}
            - Region: {{ digitalocean_region_name }}
            - Size: {{ digitalocean_size }} ({{ digitalocean_vcpus }} vCPU, {{ digitalocean_memory_mb }}MB RAM)

          Cloudflare:
            - Zone: {{ cloudflare_zone }}
            - SSL Mode: {{ cloudflare_ssl_mode }}
            - Plan: {{ cloudflare_plan }}

          Websites:
            - Main: https://www.pausatf.org (/var/www/html)
            - Transit: /var/www/transit/html (legacy)

          Stack:
            - Web: {{ web_server | default('apache') }}
            - PHP: {{ php_version }}
            - MySQL: {{ mysql_version }}
            - WordPress: {{ wordpress_installs[0].wp_version | default('latest') }}
      tags: always

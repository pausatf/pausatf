#cloud-config
# Base Cloud-init Configuration for PAUSATF Droplets
#
# This template provides base system configuration for all PAUSATF droplets.
# Use this as a foundation and extend with web server specific configs.
#
# Variables:
#   ${hostname} - Server hostname
#   ${environment} - Environment name (production, staging, development)

# System configuration
hostname: ${hostname}
fqdn: ${hostname}.pausatf.org
manage_etc_hosts: true
preserve_hostname: false

# Set timezone to Pacific (San Francisco)
timezone: America/Los_Angeles

# System locale
locale: en_US.UTF-8

# Package management
package_update: true
package_upgrade: true
package_reboot_if_required: true

# Base packages for all servers
packages:
  # System utilities
  - curl
  - wget
  - git
  - htop
  - vim
  - tmux
  - ncdu
  - tree

  # Network tools
  - net-tools
  - dnsutils
  - traceroute
  - netcat

  # Security
  - fail2ban
  - ufw
  - unattended-upgrades

  # Monitoring
  - sysstat
  - iotop

  # Build tools
  - build-essential
  - software-properties-common
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

# Create environment marker file
write_files:
  - path: /etc/environment
    content: |
      ENVIRONMENT=${environment}
      HOSTNAME=${hostname}
    append: true

  # Unattended upgrades configuration
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
        "$${distro_id}:$${distro_codename}-security";
        "$${distro_id}ESMApps:$${distro_codename}-apps-security";
        "$${distro_id}ESM:$${distro_codename}-infra-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
      Unattended-Upgrade::Automatic-Reboot-Time "03:00";
    permissions: '0644'

  # Fail2ban local configuration
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5

      [sshd]
      enabled = true
      port = ssh
      logpath = %(sshd_log)s
      backend = %(sshd_backend)s
    permissions: '0644'

# System configuration commands
runcmd:
  # Update system
  - apt-get update

  # Configure firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow OpenSSH
  - echo "y" | ufw enable

  # Enable and start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Enable unattended upgrades
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades

  # Set proper permissions
  - chmod 0600 /etc/environment

  # Create log marker
  - echo "Base cloud-init completed for ${environment} at $(date)" > /var/log/cloud-init-base.log

  # Disable root password login (SSH key only)
  - sed -i 's/PermitRootLogin yes/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config
  - systemctl restart sshd

# SSH configuration
ssh_pwauth: false
disable_root: false

# Final message
final_message: |
  Cloud-init base configuration completed!
  Environment: ${environment}
  Hostname: ${hostname}
  System ready for application-specific configuration.
  Uptime: $UPTIME

power_state:
  mode: reboot
  condition: true
